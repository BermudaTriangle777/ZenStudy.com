<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Insta DM Neomorphic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <!-- Pinch Zoom JS for image zooming -->
  <script src="https://cdn.jsdelivr.net/npm/pinch-zoom-js@2.3.4/dist/pinch-zoom.umd.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: radial-gradient(ellipse at 50% 30%, #e0e7ff 60%, #c7d2fe 100%);
      color: #222;
      overflow: hidden;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .dm-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 62px;
      background: #e0e7ff;
      box-shadow: 0 4px 24px #b6b9d6, 0 1px 0 #fff inset;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
      border-bottom-left-radius: 32px 16px;
      border-bottom-right-radius: 32px 16px;
      backdrop-filter: blur(8px);
      box-shadow:
        0 2px 16px #b6b9d6,
        0 1px 0 #fff inset,
        2px 2px 8px #b6b9d6,
        -2px -2px 8px #fff;
    }
    .dm-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
      max-width: 60vw;
    }
    .dm-header-avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #dbeafe;
      background: #e0e7ff;
      box-shadow: 0 2px 8px #b6b9d6, -2px -2px 8px #fff;
    }
    .dm-header-user {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .dm-header-user a {
      color: #3730a3;
      font-weight: 700;
      font-size: 1.08em;
      text-decoration: none;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      transition: color 0.2s;
    }
    .dm-header-user a:hover { color: #6366f1; text-decoration: underline; }
    .dm-header-user .dm-header-username {
      font-size: 0.92em;
      color: #6366f1;
      font-weight: 600;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    .dm-header-icons {
      display: flex;
      gap: 12px;
      font-size: 1.2em;
      color: #6366f1;
      align-items: center;
    }
    .dm-header-icons i {
      cursor: pointer;
      border-radius: 50%;
      background: #e0e7ff;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #b6b9d6, 0 0 0 2px #fff;
      transition: color 0.2s, background 0.2s, transform 0.1s;
    }
    .dm-header-icons i:hover {
      color: #fff;
      background: #6366f1;
      transform: scale(1.08);
    }
    .chat-area {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 520px;
      margin: 0 auto;
      padding: 0 0 0 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      margin-top: 74px;
      margin-bottom: 110px;
      min-height: 0;
      background: none;
      box-sizing: border-box;
    }
    .insta-text-msg, .insta-emoji-msg, .insta-img-msg, .insta-voice-msg {
      max-width: 70%;
      margin: 6px 0;
      padding: 0.7em 1.2em;
      border-radius: 1.5em;
      font-size: 1.05em;
      word-break: break-word;
      box-shadow:
        0 2px 12px #6366f122,
        2px 2px 8px #b6b9d6,
        -2px -2px 8px #fff,
        0 1px 0 #fff inset;
      transition: background 0.2s;
      display: inline-block;
      position: relative;
      background: #e0e7ff !important;
      color: #3730a3;
      align-self: flex-start;
      margin-right: auto;
      margin-left: 0;
      opacity: 1;
    }
    .insta-text-msg.user-msg, .insta-emoji-msg.user-msg, .insta-img-msg.user-img-msg, .insta-voice-msg.user-msg {
      background: linear-gradient(90deg, #6366f1 10%, #818cf8 90%) !important;
      color: #fff;
      align-self: flex-end;
      margin-left: auto;
      margin-right: 0;
      box-shadow:
        0 2px 12px #6366f122,
        2px 2px 8px #6366f1,
        -2px -2px 8px #fff,
        0 1px 0 #fff inset;
      opacity: 1;
    }
    .insta-emoji-msg {
      background: none !important;
      font-size: 2.1em;
      line-height: 1.2;
      padding: 0.2em 0.5em;
      box-shadow: none;
    }
    .insta-img-msg {
      background: #f3f4f6 !important;
      padding: 0.3em;
      border-radius: 1.2em;
      box-shadow: 0 2px 12px #6366f122, 2px 2px 8px #b6b9d6, -2px -2px 8px #fff;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      cursor: pointer;
      opacity: 1;
    }
    .insta-img-msg img {
      max-width: 220px;
      max-height: 220px;
      border-radius: 1em;
      box-shadow: 0 2px 12px #6366f122;
      background: #fff;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(.4,2,.6,1), box-shadow 0.25s;
      opacity: 1;
      touch-action: none;
    }
    .insta-img-msg img:active {
      transform: scale(0.97);
      box-shadow: 0 4px 24px #6366f122;
    }
    .insta-voice-msg {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e0e7ff !important;
      color: #3730a3;
      padding: 0.5em 1em;
      border-radius: 1.5em;
      min-width: 120px;
      box-shadow: 0 2px 12px #6366f122, 2px 2px 8px #b6b9d6, -2px -2px 8px #fff;
      opacity: 1;
    }
    .insta-voice-msg.user-msg {
      background: linear-gradient(90deg, #6366f1 10%, #818cf8 90%) !important;
      color: #fff;
      box-shadow: 0 2px 12px #6366f122, 2px 2px 8px #6366f1, -2px -2px 8px #fff;
      opacity: 1;
    }
    .insta-voice-msg audio {
      outline: none;
      width: 120px;
      height: 28px;
      border-radius: 8px;
      background: #fff;
    }
    .footer-float {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 20;
      display: flex;
      justify-content: center;
      align-items: end;
      padding-bottom: 18px;
      background: none;
      pointer-events: none;
      height: 100px;
    }
    .input-float {
      pointer-events: auto;
      background: #e0e7ff;
      box-shadow:
        0 2px 16px 0 #6366f122,
        2px 2px 8px #b6b9d6,
        -2px -2px 8px #fff,
        0 1px 0 #fff inset;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0 10px;
      height: 54px;
      max-width: 480px;
      width: 98vw;
      margin: 0 auto;
      position: relative;
      border: none;
    }
    .input-float .icon-btn {
      background: #e0e7ff;
      border: none;
      outline: none;
      color: #6366f1;
      font-size: 1.2em;
      cursor: pointer;
      border-radius: 50%;
      width: 38px; height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #b6b9d6, 0 0 0 2px #fff;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    .input-float .icon-btn:active, .input-float .icon-btn.active {
      background: #6366f1;
      color: #fff;
      box-shadow: 0 2px 8px #6366f122;
      transform: scale(0.97);
    }
    .input-float .icon-btn[disabled] {
      opacity: 0.5;
      pointer-events: none;
    }
    .input-float input[type="text"] {
      flex: 1 1 auto;
      background: #e0e7ff;
      border: none;
      outline: none;
      font-size: 1.08em;
      color: #3730a3;
      font-family: inherit;
      font-weight: 500;
      padding: 0 8px;
      min-width: 0;
      border-radius: 18px;
      margin: 0 2px;
      height: 38px;
      box-shadow: inset 2px 2px 8px #b6b9d6, inset -2px -2px 8px #fff;
      transition: box-shadow 0.2s;
    }
    .input-float input[type="text"]:focus {
      box-shadow: 0 0 0 2px #6366f1, inset 2px 2px 8px #b6b9d6, inset -2px -2px 8px #fff;
    }
    .input-float .send-btn {
      background: linear-gradient(90deg, #6366f1 10%, #818cf8 90%);
      color: #fff;
      font-size: 1.2em;
      border-radius: 50%;
      width: 38px; height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #6366f122;
      margin-left: 4px;
      transition: opacity 0.2s;
      border: none;
    }
    .input-float .send-btn.hidden { display: none; }
    input[type="file"].hidden { display: none !important; }
    emoji-picker {
      position: absolute;
      bottom: 60px;
      left: 0;
      right: 0;
      margin: auto;
      width: 320px !important;
      max-width: 90vw;
      z-index: 9999;
      border-radius: 18px;
      box-shadow: 0 8px 32px #6366f122;
      background: #fff;
      border: 2px solid #dbeafe;
      font-family: inherit;
      transition: none !important;
      animation: none !important;
    }
    emoji-picker.hidden { display: none !important; }
    emoji-picker::part(search), emoji-picker::part(categories) { display: none !important; }
    .voice-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e0e7ff;
      border-radius: 999px;
      box-shadow: 0 2px 16px 0 #6366f122, 2px 2px 8px #b6b9d6, -2px -2px 8px #fff;
      padding: 0 18px;
      height: 54px;
      max-width: 480px;
      width: 98vw;
      margin: 0 auto;
      position: absolute;
      left: 0; right: 0; bottom: 18px;
      z-index: 30;
      animation: popIn 0.2s;
    }
    .voice-bar .icon-btn {
      background: #e0e7ff;
      color: #6366f1;
      width: 38px; height: 38px;
      border-radius: 50%;
      box-shadow: 0 2px 8px #b6b9d6, 0 0 0 2px #fff;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .voice-bar .icon-btn:active {
      background: #6366f1;
      color: #fff;
      box-shadow: 0 2px 8px #6366f122;
      transform: scale(0.97);
    }
    .voice-bar .icon-btn[disabled] {
      opacity: 0.5;
      pointer-events: none;
    }
    .voice-bar .timer {
      font-size: 1.1em;
      color: #6366f1;
      font-weight: 700;
      min-width: 60px;
      text-align: center;
      letter-spacing: 0.04em;
    }
    .voice-anim {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
    }
    .voice-anim .mic-pulse {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(90deg, #6366f1 10%, #818cf8 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 1s infinite;
      position: relative;
    }
    .voice-anim .mic-pulse i {
      color: #fff;
      font-size: 1.2em;
      z-index: 2;
      position: relative;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4);}
      70% { box-shadow: 0 0 0 12px rgba(99,102,241,0);}
      100% { box-shadow: 0 0 0 0 rgba(99,102,241,0);}
    }
    #fullImagePreview {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30, 41, 59, 0.18);
      backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transform: scale(0.98);
      pointer-events: none;
      transition: opacity 0.25s cubic-bezier(.4,2,.6,1), transform 0.25s cubic-bezier(.4,2,.6,1);
    }
    #fullImagePreview.active {
      display: flex;
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    #fullImagePreview .pinch-zoom {
      max-height: 75vh;
      max-width: 92vw;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 8px 32px #6366f122;
      overflow: hidden;
      touch-action: none;
    }
    #fullImagePreview img {
      max-height: 75vh;
      max-width: 92vw;
      object-fit: contain;
      border-radius: 18px;
      background: #fff;
      transition: box-shadow 0.25s, transform 0.25s;
      display: block;
      width: 100%;
      height: auto;
      touch-action: none;
      user-select: none;
      pointer-events: auto;
    }
    .preview-header {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 1rem;
      display: flex;
      justify-content: flex-start;
    }
    .preview-footer {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
    }
    .share-btn-large, .save-btn-large {
      background: linear-gradient(90deg, #6366f1 10%, #818cf8 90%);
      color: white;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px #6366f122;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .share-btn-large:active, .save-btn-large:active { opacity: 0.8; }
    .close-btn-large {
      background: #fff;
      padding: 8px;
      border-radius: 50%;
      font-size: 1.1rem;
      color: #6366f1;
      border: 2px solid #dbeafe;
      box-shadow: 0 2px 8px #6366f122;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .close-btn-large:hover {
      background: #6366f1;
      color: #fff;
    }
    .chat-area::-webkit-scrollbar { display: none; }
    .chat-area { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @media (max-width: 600px) {
      .dm-header { padding: 0 8px; }
      .chat-area { max-width: 100vw; }
      .input-float, .voice-bar { max-width: 99vw; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="dm-header">
    <div class="dm-header-left">
      <img src="https://i.imgur.com/1Q9Z1Zm.png" class="dm-header-avatar" />
      <div class="dm-header-user">
        <a href="https://instagram.com/pravvveennnn" target="_blank">@pravvveennnn</a>
        <span class="dm-header-username">pravv...</span>
      </div>
    </div>
    <div class="dm-header-icons">
      <i class="fas fa-user-friends"></i>
      <i class="fas fa-phone"></i>
      <i class="fas fa-video"></i>
    </div>
  </div>
  <!-- Chat Area -->
  <div id="chatArea" class="chat-area"></div>
  <!-- Floating Footer (Input + Buttons) -->
  <footer class="footer-float">
    <form class="input-float" id="chatForm" autocomplete="off" onsubmit="return false;">
      <button type="button" id="cameraIcon" class="icon-btn" title="Take Photo"><i class="fas fa-camera"></i></button>
      <input id="messageInput" type="text" placeholder="Message..." autocomplete="off" />
      <button type="button" id="micBtn" class="icon-btn" title="Record Voice"><i class="fas fa-microphone"></i></button>
      <button type="button" id="galleryEmojiBtn" class="icon-btn" title="Send Photo"><i class="far fa-image"></i></button>
      <button type="button" id="emojiBtn" class="icon-btn" title="Emoji"><i class="far fa-smile"></i></button>
      <button id="sendButton" class="send-btn hidden" type="submit"><i class="fas fa-paper-plane"></i></button>
      <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" />
      <emoji-picker id="emojiPicker" class="hidden"></emoji-picker>
    </form>
    <div id="voiceBar" class="voice-bar" style="display:none;">
      <span class="voice-anim"><span class="mic-pulse"><i class="fas fa-microphone"></i></span></span>
      <span class="timer" id="voiceTimer">0:00</span>
      <button type="button" id="sendVoice" class="icon-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
      <button type="button" id="cancelVoice" class="icon-btn" title="Cancel"><i class="fas fa-times"></i></button>
    </div>
  </footer>
  <!-- Fullscreen Image Preview -->
  <div id="fullImagePreview" class="flex">
    <div class="preview-header">
      <button class="close-btn-large" id="closePreviewBtn"><i class="fas fa-arrow-left"></i></button>
    </div>
    <div id="pinchZoomContainer" class="pinch-zoom">
      <img id="previewImageFull" src="" />
    </div>
    <div class="preview-footer">
      <button class="share-btn-large" id="confirmSendImage"><i class="fas fa-paper-plane"></i></button>
      <button class="save-btn-large" id="saveImageBtn" title="Save to device"><i class="fas fa-download"></i></button>
    </div>
  </div>
  <script>
    // Demo chat logic (replace with your Firebase logic)
    const chatArea = document.getElementById("chatArea");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendButton");
    const cameraIcon = document.getElementById("cameraIcon");
    const galleryEmojiBtn = document.getElementById("galleryEmojiBtn");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const imageInput = document.getElementById("imageInput");
    const fullImagePreview = document.getElementById("fullImagePreview");
    const previewImageFull = document.getElementById("previewImageFull");
    const pinchZoomContainer = document.getElementById("pinchZoomContainer");
    const closePreviewBtn = document.getElementById("closePreviewBtn");
    const confirmSendImage = document.getElementById("confirmSendImage");
    const saveImageBtn = document.getElementById("saveImageBtn");
    const micBtn = document.getElementById("micBtn");
    const chatForm = document.getElementById("chatForm");
    const voiceBar = document.getElementById("voiceBar");
    const voiceTimer = document.getElementById("voiceTimer");
    const cancelVoice = document.getElementById("cancelVoice");
    const sendVoice = document.getElementById("sendVoice");
    let imgPreviewData = null;
    let imgPreviewDownloadName = "image.jpg";
    let pinchZoomInstance = null;

    // Hide image preview by default
    fullImagePreview.classList.remove("active");
    fullImagePreview.style.display = "none";

    // Demo messages
    let messages = [
      {type: "text", content: "Hey! 👋", from: "admin"},
      {type: "text", content: "Welcome to your premium DM!", from: "admin"},
    ];

    function renderMessages() {
      chatArea.innerHTML = "";
      messages.forEach((m, idx) => {
        let div;
        if (m.type === "text") {
          div = document.createElement("div");
          div.className = "insta-text-msg";
          div.textContent = m.content;
          if (!m.from || m.from !== "admin") div.classList.add("user-msg");
        } else if (m.type === "emoji") {
          div = document.createElement("div");
          div.className = "insta-emoji-msg";
          div.textContent = m.content;
          if (!m.from || m.from !== "admin") div.classList.add("user-msg");
        } else if (m.type === "image") {
          div = document.createElement("div");
          div.className = "insta-img-msg";
          const img = document.createElement("img");
          img.src = m.content;
          img.alt = "Sent image";
          img.style.cursor = "pointer";
          img.addEventListener("click", () => {
            previewImageFull.src = m.content;
            imgPreviewData = m.content;
            imgPreviewDownloadName = `insta_dm_image_${idx+1}.jpg`;
            fullImagePreview.style.display = "flex";
            setTimeout(() => fullImagePreview.classList.add("active"), 10);
            confirmSendImage.style.display = "none";
            saveImageBtn.style.display = "inline-flex";
            // Pinch zoom
            setTimeout(() => {
              if (pinchZoomInstance) pinchZoomInstance.destroy();
              pinchZoomInstance = new PinchZoom(pinchZoomContainer, { draggableUnzoomed: false });
            }, 50);
          });
          div.appendChild(img);
          if (!m.from || m.from !== "admin") div.classList.add("user-img-msg");
        } else if (m.type === "voice") {
          div = document.createElement("div");
          div.className = "insta-voice-msg";
          if (!m.from || m.from !== "admin") div.classList.add("user-msg");
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = m.content;
          div.appendChild(audio);
        }
        chatArea.appendChild(div);
      });
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    renderMessages();

    // Send message logic
    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      messages.push({type: (/^[\p{Emoji}\u200d\s]+$/u.test(msg) ? "emoji" : "text"), content: msg});
      input.value = "";
      sendBtn.classList.add("hidden");
      renderMessages();
    }
    sendBtn.addEventListener("click", sendMessage);
    chatForm.addEventListener("submit", e => {
      e.preventDefault();
      sendMessage();
    });
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    input.addEventListener("input", () => {
      if (input.value.trim()) {
        sendBtn.classList.remove("hidden");
      } else {
        sendBtn.classList.add("hidden");
      }
    });

    // Emoji picker
    emojiBtn.addEventListener("click", e => {
      e.stopPropagation();
      emojiPicker.classList.toggle("hidden");
      emojiBtn.classList.toggle("active");
    });
    emojiPicker.addEventListener("emoji-click", e => {
      const emoji = e.detail.unicode;
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
      sendBtn.classList.remove("hidden");
    });
    document.addEventListener("click", e => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.classList.add("hidden");
        emojiBtn.classList.remove("active");
      }
    });

    // Camera and gallery
    cameraIcon.addEventListener("click", () => {
      imageInput.setAttribute("capture", "environment");
      imageInput.click();
    });
    galleryEmojiBtn.addEventListener("click", () => {
      imageInput.removeAttribute("capture");
      imageInput.click();
    });
    imageInput.addEventListener("change", async () => {
      const file = imageInput.files[0];
      if (file) {
        // Compress image before preview
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.onload = function () {
            let width = img.width, height = img.height, maxSize = 800;
            if (width > maxSize || height > maxSize) {
              if (width > height) { height *= maxSize / width; width = maxSize; }
              else { width *= maxSize / height; height = maxSize; }
            }
            const canvas = document.createElement("canvas");
            canvas.width = width; canvas.height = height;
            canvas.getContext("2d").drawImage(img, 0, 0, width, height);
            imgPreviewData = canvas.toDataURL("image/jpeg", 0.8);
            previewImageFull.src = imgPreviewData;
            imgPreviewDownloadName = file.name || "image.jpg";
            fullImagePreview.style.display = "flex";
            setTimeout(() => fullImagePreview.classList.add("active"), 10);
            confirmSendImage.style.display = "inline-flex";
            saveImageBtn.style.display = "none";
            setTimeout(() => {
              if (pinchZoomInstance) pinchZoomInstance.destroy();
              pinchZoomInstance = new PinchZoom(pinchZoomContainer, { draggableUnzoomed: false });
            }, 50);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    closePreviewBtn.addEventListener("click", () => {
      fullImagePreview.classList.remove("active");
      setTimeout(() => { fullImagePreview.style.display = "none"; }, 250);
      imgPreviewData = null;
      if (pinchZoomInstance) pinchZoomInstance.destroy();
    });
    confirmSendImage.addEventListener("click", () => {
      if (!imgPreviewData) return;
      messages.push({type: "image", content: imgPreviewData});
      fullImagePreview.classList.remove("active");
      setTimeout(() => { fullImagePreview.style.display = "none"; }, 250);
      imgPreviewData = null;
      if (pinchZoomInstance) pinchZoomInstance.destroy();
      renderMessages();
    });

    // Save image to device
    saveImageBtn.addEventListener("click", () => {
      if (!imgPreviewData) return;
      const a = document.createElement("a");
      a.href = imgPreviewData;
      a.download = imgPreviewDownloadName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Voice recording
    let mediaRecorder = null, audioChunks = [], voiceInterval, voiceSeconds = 0, voiceSend = false, stream = null, isRecording = false, isStopping = false;
    micBtn.addEventListener("click", async () => {
      if (isRecording || isStopping) return; // Prevent double record
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Voice recording not supported in this browser.");
        return;
      }
      try {
        micBtn.setAttribute("disabled", "disabled");
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        voiceSend = false;
        isRecording = true;
        isStopping = false;
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          isRecording = false;
          isStopping = false;
          micBtn.removeAttribute("disabled");
          if (stream) stream.getTracks().forEach(track => track.stop());
          if (voiceSend && audioChunks.length) {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const audioUrl = URL.createObjectURL(audioBlob);
            messages.push({type: "voice", content: audioUrl});
            renderMessages();
          }
          chatForm.style.display = "flex";
          voiceBar.style.display = "none";
        };
        mediaRecorder.start();
        voiceSeconds = 0;
        voiceTimer.textContent = "0:00";
        voiceBar.style.display = "flex";
        chatForm.style.display = "none";
        voiceInterval = setInterval(() => {
          voiceSeconds++;
          voiceTimer.textContent = `${Math.floor(voiceSeconds/60)}:${(voiceSeconds%60).toString().padStart(2,"0")}`;
        }, 1000);
      } catch (e) {
        alert("Microphone access denied.");
        isRecording = false;
        isStopping = false;
        micBtn.removeAttribute("disabled");
      }
    });
    cancelVoice.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording" && !isStopping) {
        isStopping = true;
        voiceSend = false;
        mediaRecorder.stop();
        chatForm.style.display = "flex";
        voiceBar.style.display = "none";
      }
      clearInterval(voiceInterval);
      micBtn.removeAttribute("disabled");
    });
    sendVoice.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording" && !isStopping) {
        isStopping = true;
        voiceSend = true;
        mediaRecorder.stop();
        chatForm.style.display = "flex";
        voiceBar.style.display = "none";
      }
      clearInterval(voiceInterval);
      micBtn.removeAttribute("disabled");
    });
  </script>
</body>
</html>
